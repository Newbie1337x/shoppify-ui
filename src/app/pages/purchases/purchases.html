<div class="purchases-container">
  <h2>üõçÔ∏è Mis Compras</h2>


  <div class="filters">
    <label>Desde: <input type="date" [(ngModel)]="filters.startDate"></label>
    <label>Hasta: <input type="date" [(ngModel)]="filters.endDate"></label>
    <label>M√©todo de pago:
      <select [(ngModel)]="filters.paymentMethod">
        <option value="">Todos</option>
        <option value="CASH">Efectivo</option>
        <option value="CREDIT">Tarjeta</option>
        <option value="DEBIT">Debito</option>
        <option value="DIGITAL">Transferencia</option>
      </select>
    </label>
    <label>M√≠nimo: <input type="number" [(ngModel)]="filters.minPrice"></label>
    <label>M√°ximo: <input type="number" [(ngModel)]="filters.maxPrice"></label>

    <button (click)="applyFilters()">Filtrar</button>

    @if (isAdmin) {
    <button type="button" (click)="toggleAdminView()" class="admin-toggle" id="admin-toggle"
      [ngClass]="{ 'active': adminView }">
      Ver todas las compras
    </button>
    }

    <label>Mostrar:
      <select [(ngModel)]="purchasesXPage" (change)="loadTransactions()">
        <option [value]="5">5</option>
        <option [value]="10">10</option>
        <option [value]="25">25</option>
        <option [value]="50">50</option>
      </select>
      por p√°gina
    </label>
  </div>

  @if (purchases().length > 0) {
  <div class="pagination">
    <button (click)="changePage(currentPage - 1)" [disabled]="currentPage === 0">Anterior</button>
    <span>P√°gina {{ currentPage + 1 }} de {{ totalPages }}</span>
    <button (click)="changePage(currentPage + 1)" [disabled]="currentPage >= totalPages - 1">Siguiente</button>
  </div>

  <div class="purchases-list">
    @for (purchase of purchases(); let i = $index; track purchase.id) {
    <div class="purchase-card">
      <div class="purchase-header">
        <div class="purchase-summary">
          <p>Fecha: {{ purchase.dateTime | date:'short' }}</p>
          <p>Total: <strong>${{ purchase.total | number:'1.2-2' }}</strong></p>
        </div>
        <button class="toggle-details" (click)="toggleDetails(i)">
          {{ activePurchase() === i ? 'Ocultar detalles ‚Üë' : 'Mostrar detalles ‚Üì' }}
        </button>
      </div>

      <div class="purchase-details-wrapper" [class.show]="activePurchase() === i">
        <div class="purchase-details">
          <h4>Productos</h4>
          <ul>
            @for (item of purchase.detailTransactions; track item.id) {

            <li>
              <div class="item-info">
                <img (click)="gotoDetailsProduct(item.product?.id)" [src]="item.product?.imgURL"
                  alt="{{ item.product?.name }}" />
                <div class="item-text">
                  <p><strong>{{ item.product?.name }}</strong></p>
                  <p>Cantidad: {{ item.quantity }}</p>
                  <p>Precio unitario: ${{ item.product?.price | number:'1.2-2' }}</p>
                  <p>Subtotal: <strong>${{ item.subtotal | number:'1.2-2' }}</strong></p>
                </div>
              </div>
            </li>
            }
          </ul>

          <div class="purchase-extra">
            <p><strong>M√©todo de pago:</strong> {{ purchase.paymentMethod }}</p>
            <p><strong>Descripci√≥n:</strong> {{ purchase.description || 'Sin descripci√≥n' }}</p>
          </div>
        </div>
      </div>
    </div>
    }
  </div>

  } @else if(filters.startDate || filters.endDate || filters.paymentMethod || filters.minPrice || filters.maxPrice) {
    <div class="no-results">
      <p>No se encontraron compras que coincidan con los filtros aplicados üòï</p>
    </div>
  } @else{
    <div class="empty-purchases">
      <p>No ten√©s compras registradas todav√≠a üòï</p>
    </div>
  }
</div>